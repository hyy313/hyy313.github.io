<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="memory management - allocator analyz"><base href=https://hyy313.github.io/><title>重新学c++ day14 内存管理 allocator analyz</title><link rel=canonical href=https://hyy313.github.io/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/><link rel=stylesheet href=https://hyy313.github.io/scss/style.min.css><meta property="og:title" content="重新学c++ day14 内存管理 allocator analyz"><meta property="og:description" content="memory management - allocator analyz"><meta property="og:url" content="https://hyy313.github.io/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/"><meta property="og:site_name" content="hyy space"><meta property="og:type" content="article"><meta name=twitter:title content="重新学c++ day14 内存管理 allocator analyz"><meta name=twitter:description content="memory management - allocator analyz"><meta property="article:section" content="Post"><meta property="article:tag" content="memory management"><meta property="article:tag" content="code"><meta property="article:published_time" content="2020-12-14T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-14T00:00:00+00:00"></head><body><div id=content><div class="container extended flex on-phone--column align-items--flex-start article-page with-toolbar"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><img src=/img/hhh1_hue2459b0030efa4a20d8b2aaa18153577_8197_300x300_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
<span class=emoji>🍥</span></figure><h1 class=site-name><a href=https://hyy313.github.io/>hyy space</a></h1><h2 class=site-description>code make me happy</h2></header><nav class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archive/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archive</span></a></li></nav></aside><div class="flex column do-not-overflow full-width"><main class=main><div id=article-toolbar><a href=https://hyy313.github.io/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/c++>C++</a></header><h2 class=article-title><a href=https://hyy313.github.io/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/>重新学c++ day14 内存管理 allocator analyz</a></h2><h3 class=article-subtitle>memory management - allocator analyz</h3><footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--published>Dec 14, 2020</time></footer></div></header><section class=article-content><p>源自侯捷老师内存管理课程！</p><h1 id=allocator-analyz>allocator analyz</h1><h2 id=gnc-allocator>GNC allocator</h2><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc.jpg data-size=1421x698><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc_huda7af2f8d0c9d44e2e9336f2401de9a1_228899_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc_huda7af2f8d0c9d44e2e9336f2401de9a1_228899_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc.jpg width=1421 height=698 loading=lazy alt=&nbsp;></a></figure></p><p>allocator诞生就是为了给容器使用，本质目的就是为了节省内存空间，去除malloc分配带来的cookie。部分allocator还是通过new/delete调用malloc/free。</p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc2.jpg data-size=1428x798><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc2_huf7ff18681054673f66ea0482b2840d0d_226249_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc2_huf7ff18681054673f66ea0482b2840d0d_226249_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc2.jpg width=1428 height=798 loading=lazy alt=&nbsp;></a></figure></p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc3.jpg data-size=924x768><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc3_hucd5848ee438bd768e8d61509c70a1459_167925_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc3_hucd5848ee438bd768e8d61509c70a1459_167925_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc3.jpg width=924 height=768 loading=lazy alt=&nbsp;></a></figure></p><p>智能型allocator，就是使用缓存思想构建内存池，供所有容器共享（应该是使用该分配器的，但是内存池不是容器构建的吗？全局静态allocator，大家共享！）。</p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc4.jpg data-size=1421x715><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc4_hu46a827792b892df4ca0a62a1c62aefa8_259435_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc4_hu46a827792b892df4ca0a62a1c62aefa8_259435_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc4.jpg width=1421 height=715 loading=lazy alt=&nbsp;></a></figure></p><p>GNC提供了三个评价allocator的性能指标：插入性能、多线程插入删除、单线程生产者消费者模型性能。</p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc5.jpg data-size=1384x849><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc5_hu9a85596e7d1cd729b287d7d5d07796b5_265929_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc5_hu9a85596e7d1cd729b287d7d5d07796b5_265929_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GNC_alloc5.jpg width=1384 height=849 loading=lazy alt=&nbsp;></a></figure></p><p>另外的allocator：</p><ol><li>debug_allocator：为调用malloc/delete做一层封装;</li><li>array_allocator：对已有数组封装。</li></ol><h2 id=vs2013-allocator>vs2013 allocator</h2><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/vs2013_alloc.jpg data-size=1457x824><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/vs2013_alloc_hu629682c5ed6a417aaad882e45b5a4861_241588_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/vs2013_alloc_hu629682c5ed6a417aaad882e45b5a4861_241588_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/vs2013_alloc.jpg width=1457 height=824 loading=lazy alt=&nbsp;></a></figure></p><p>直接调用new/delete。</p><h2 id=gn49-allocator>GN4.9 allocator</h2><h3 id=std_allocator>std_allocator</h3><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_std_alloc.jpg data-size=1470x815><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_std_alloc_hu0008a6ca0cd43b88da8a8c0e8a1af3a5_227355_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_std_alloc_hu0008a6ca0cd43b88da8a8c0e8a1af3a5_227355_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_std_alloc.jpg width=1470 height=815 loading=lazy alt=&nbsp;></a></figure></p><p>直接调用new/delete。</p><h3 id=malloc-allocator>malloc allocator</h3><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_malloc_alloc.jpg data-size=1155x833><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_malloc_alloc_hu384a6e73412e6cc2fe4e0aa6b520eae5_144949_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_malloc_alloc_hu384a6e73412e6cc2fe4e0aa6b520eae5_144949_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_malloc_alloc.jpg width=1155 height=833 loading=lazy alt=&nbsp;></a></figure></p><p>直接调用malloc/free。</p><h3 id=malloc-array-allocator>malloc array allocator</h3><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_array_alloc.jpg data-size=1449x819><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_array_alloc_hu8d91615e55142d2896f6fcdcec1a0bba_175337_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_array_alloc_hu8d91615e55142d2896f6fcdcec1a0bba_175337_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_array_alloc.jpg width=1449 height=819 loading=lazy alt=&nbsp;></a></figure></p><p>对数组进行封装，故不需要deallocate，allocate只是对已有空间分配及操作大小移动。</p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_array_alloc2.jpg data-size=1457x792><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_array_alloc2_huf53b9a9b37746d5ca229b3d9d7470f39_216842_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_array_alloc2_huf53b9a9b37746d5ca229b3d9d7470f39_216842_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_array_alloc2.jpg width=1457 height=792 loading=lazy alt=&nbsp;></a></figure></p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_array_alloc3.jpg data-size=1194x783><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_array_alloc3_hu9bb71345bc9e47161bbd41f9d126087c_136044_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_array_alloc3_hu9bb71345bc9e47161bbd41f9d126087c_136044_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_array_alloc3.jpg width=1194 height=783 loading=lazy alt=&nbsp;></a></figure></p><h3 id=debug-allocator>debug allocator</h3><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_debug_alloc.jpg data-size=1429x837><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_debug_alloc_hu1a94242650c5a9ce9c0fab1f8324d553_221318_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_debug_alloc_hu1a94242650c5a9ce9c0fab1f8324d553_221318_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_debug_alloc.jpg width=1429 height=837 loading=lazy alt=&nbsp;></a></figure></p><p>模仿malloc中的debugheader加了一个大小模块，同时又采用结构体对齐思想。</p><h3 id=gn29-std_alloc>GN2.9 std_alloc</h3><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN2_std_alloc.jpg data-size=1240x745><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN2_std_alloc_hu0a294922ff52a614c22a966f6473eff3_142905_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN2_std_alloc_hu0a294922ff52a614c22a966f6473eff3_142905_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN2_std_alloc.jpg width=1240 height=745 loading=lazy alt=&nbsp;></a></figure></p><h3 id=pool_alloc>pool_alloc</h3><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_pool_alloc.jpg data-size=1458x809><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_pool_alloc_hub2c9542c5e196e31c66495483ef01d59_238896_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_pool_alloc_hub2c9542c5e196e31c66495483ef01d59_238896_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_pool_alloc.jpg width=1458 height=809 loading=lazy alt=&nbsp;></a></figure></p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_pool_alloc_case.jpg data-size=1430x748><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_pool_alloc_case_hue1570aa1b70f51a6e813e043db24b653_235908_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_pool_alloc_case_hue1570aa1b70f51a6e813e043db24b653_235908_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_pool_alloc_case.jpg width=1430 height=748 loading=lazy alt=&nbsp;></a></figure></p><h3 id=bitmap-allocator>bitmap allocator</h3><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc.jpg data-size=1084x782><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc_hu10a8c9dedb16c473758669639fff0a69_138913_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc_hu10a8c9dedb16c473758669639fff0a69_138913_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc.jpg width=1084 height=782 loading=lazy alt=&nbsp;></a></figure></p><p>bitmap_alloc：一个元素一个元素分配，多个元素就调用new/delete处理。
挖一大块，一个一个分配，标准内存池思想。</p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc2.jpg data-size=1473x709><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc2_hu186de4450db01cb0ad0e7162a1427096_111393_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc2_hu186de4450db01cb0ad0e7162a1427096_111393_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc2.jpg width=1473 height=709 loading=lazy alt=&nbsp;></a></figure></p><p>blocks：待分配的内存块。</p><p>super-blocks：内存块与位图、使用量、大小（内存块+位图+使用量）组成的内存空间管理集合。</p><p>bitmap：与每个块按位对应，从低位到高位表示从第一块到第n块是否使用。</p><p>mini-vector：管理内存池的vector，不使用标准是为了避免allocator权责不清，鸡生蛋还是蛋生鸡？</p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc3.jpg data-size=1475x531><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc3_hu28f22f9308b9a6ee639e76f1255b6622_87270_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc3_hu28f22f9308b9a6ee639e76f1255b6622_87270_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc3.jpg width=1475 height=531 loading=lazy alt=&nbsp;></a></figure></p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc4.jpg data-size=1475x522><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc4_hubd5750752848ac332a1dfc2a7304d1de_87572_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc4_hubd5750752848ac332a1dfc2a7304d1de_87572_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc4.jpg width=1475 height=522 loading=lazy alt=&nbsp;></a></figure></p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc5.jpg data-size=1476x528><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc5_hucc6fe2333575e13484d64741fcc8b6fc_84764_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc5_hucc6fe2333575e13484d64741fcc8b6fc_84764_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc5.jpg width=1476 height=528 loading=lazy alt=&nbsp;></a></figure></p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc6.jpg data-size=1476x525><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc6_hu7d95202d681e46325fed333cf20330d2_87849_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc6_hu7d95202d681e46325fed333cf20330d2_87849_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc6.jpg width=1476 height=525 loading=lazy alt=&nbsp;></a></figure></p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc7.jpg data-size=1260x719><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc7_hu3f1f6f4fa05de8e3ace040b91c845881_108398_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc7_hu3f1f6f4fa05de8e3ace040b91c845881_108398_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc7.jpg width=1260 height=719 loading=lazy alt=&nbsp;></a></figure></p><p>vector大小遵循正常的双倍扩充，内存块也是。</p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc8.jpg data-size=1433x732><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc8_huc7126f7cfbbcec02597d23bc4d1afc1e_163912_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc8_huc7126f7cfbbcec02597d23bc4d1afc1e_163912_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc8.jpg width=1433 height=732 loading=lazy alt=&nbsp;></a></figure></p><p>vector中Entries只属于某个固定类型，不可混用。</p><ul><li>问题：这种设定是否增加了空间分配的代价？</li></ul><p>不曾全回收就每次申请双倍扩充，全回收就减半！</p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc9.jpg data-size=1254x775><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc9_hu8a873b4abd379dd72594524df8ab7520_166283_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc9_hu8a873b4abd379dd72594524df8ab7520_166283_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc9.jpg width=1254 height=775 loading=lazy alt=&nbsp;></a></figure></p><p>内存回收问题：回收的块来到了另一个管理回收的vector，一旦超出entries阈值64，就自动归还最大的给os，这个vector是按空间大小从小到大排序的。</p><p>回收后的分配问题，优先从后向前分配，尽量不去申请新空间！</p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc10.jpg data-size=1376x728><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc10_hu8eb8b78e6b5f51f0969fcc3608e70911_141383_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc10_hu8eb8b78e6b5f51f0969fcc3608e70911_141383_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc10.jpg width=1376 height=728 loading=lazy alt=&nbsp;></a></figure></p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc11.jpg data-size=1291x716><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc11_hua5fae77901aaa4b075f99bbc3d587686_139661_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc11_hua5fae77901aaa4b075f99bbc3d587686_139661_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_bitmap_alloc11.jpg width=1291 height=716 loading=lazy alt=&nbsp;></a></figure></p><p>基本原则：尽量不新开辟空间，利用已有空间！</p><p>此处先拉哪个出来，遵循全回收规模缩减原则！</p><h3 id=use-case>use case</h3><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_alloc.jpg data-size=1473x818><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_alloc_hue27b80eea0b10e8952a3d7f70228137e_260090_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_alloc_hue27b80eea0b10e8952a3d7f70228137e_260090_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_alloc.jpg width=1473 height=818 loading=lazy alt=&nbsp;></a></figure></p><p><figure><a href=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_alloc2.jpg data-size=1467x878><img srcset="/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_alloc2_hua2e430b4ece5a0f8ed57df9bc35a9b2a_236887_480x0_resize_q75_box.jpg 480w, /p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_alloc2_hua2e430b4ece5a0f8ed57df9bc35a9b2a_236887_1024x0_resize_q75_box.jpg 1024w" src=/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day14-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-allocator-analyz/GN4_alloc2.jpg width=1467 height=878 loading=lazy alt=&nbsp;></a></figure></p><p>导入对应头文件，通过对应using namespace调用。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/memory-management>Memory management</a>
<a href=/tags/code>Code</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licenced under CC BY-NC-SA 4.0</span></section></footer></article><aside class="widget related-contents--wrapper"><h1 class=widget-title>Related contents</h1><div class=related-contents><div class="flex article-list--tile"><article><a href=https://hyy313.github.io/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day13-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-loki-advanced-allocator/><div class=article-details><h2 class=article-title>重新学c++ day13 内存管理 loki advanced allocator</h2></div></a></article><article><a href=https://hyy313.github.io/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day12-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-loki-allocator/><div class=article-details><h2 class=article-title>重新学c++ day12 内存管理 loki allocator</h2></div></a></article><article><a href=https://hyy313.github.io/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day11-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-vc-memory-alloc/><div class=article-details><h2 class=article-title>重新学c++ day11 内存管理 vc memory alloc</h2></div></a></article><article><a href=https://hyy313.github.io/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day10-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-vc-malloc/><div class=article-details><h2 class=article-title>重新学c++ day10 内存管理 vc malloc</h2></div></a></article><article><a href=https://hyy313.github.io/p/%E9%87%8D%E6%96%B0%E5%AD%A6c-day9-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-gn2.9-stdalloc-3/><div class=article-details><h2 class=article-title>重新学c++ day9 内存管理 GN2.9 std::alloc 3</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy; 2020 hyy space</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank>Stack</a></b> designed by
<a href=https://jimmycai.com target=_blank>Jimmy</a></section></footer></main></div></div><div class=pswp tabindex=-1 role=dialog aria-hidden=true style=display:none><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const customFont=document.createElement('link');customFont.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";customFont.type="text/css";customFont.rel="stylesheet";document.head.appendChild(customFont);}());</script></body></html>